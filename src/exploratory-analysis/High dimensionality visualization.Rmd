---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

--> <https://medium.com/swlh/t-sne-explained-math-and-intuition-94599ab164cf>

```{r, setup}
#DIRECTORIES
root_proj_dir = "../../"
########### Chose one ########
dataset_path = paste(root_proj_dir,"data/data_social_woo.csv",sep="")
# dataset_path = paste(root_proj_dir,"data/data_psych_woo.csv",sep="")
########### Chose one ########
include_path = paste(root_proj_dir,"src/include/Utilities.R",sep="")
#INCLUDING UTILITIES
source(include_path)
#IMPORTING THE DATASET
pisa_data <- read.csv(file=dataset_path)
head(pisa_data)
library(rgl)
library(Rtsne)
```

# Plot divisi per categorie e livelli ANOVA
```{r}
cols = colora(4,20)
```

## social
```{r}
linear_model_vars <- readLines( "../../data/non csv/lm_social_vars.txt")

filter <- function(category,var_lm) {
  risultato <- c()
  
  for (elemento in category) {
    if (elemento %in% var_lm) {
      risultato <- c(risultato, elemento)
    }
  }
  
  return(risultato)
}


categories_variables_filtered=list()

for(cat in cat_var_names ){
  categories_variables_filtered[[cat]]=filter(categories_variables[[cat]],linear_model_vars)
}

categories_variables_filtered[["WELL-BEING"]] = c("Social.well.being","Psychological.well.being")
categories_variables_filtered
```
# Choice of perplexity
```{r}
# pisa_data$X <- NULL
# pisa_data$CNT <- as.factor(pisa_data$CNT)
# pisa_data$IM_PUBLIC <- as.factor(pisa_data$IM_PUBLIC)
# pisa_data$NEW_VAR <- as.factor(pisa_data$NEW_VAR)
# countrys =pisa_data$CNT 
# 
# pisa_data_cut = as.data.frame(scale(select_if(pisa_data,is.numeric)))
# 
# perplex = c(1,30,50)
# 
# pdf("high dimensionality plots.pdf")
# 
# for(k in perplex){
#   
#   tsne_results <- Rtsne(pisa_data_cut, perplexity=k, check_duplicates = FALSE, pca=FALSE)
#   title = paste("Perplexity = ", k)
#   plot(tsne_results$Y[,1],tsne_results$Y[,2], col = "black", bg= countrys, pch = 21, cex = 1, main = title)
#   
# }
# dev.off()
```

Chosen perplexity = 30




# Parameters and data prep
```{r}
##### Scegline uno per volta #####
covariates <- readLines("../../data/non csv/lm_social_vars.txt")
# covariates <- readLines("../../data/non csv/lm_psico_vars.txt")
##### Scegline uno per volta #####

targets = c(
	"Social.well.being",
	"Psychological.well.being"
)

model_variables = c(covariates,targets)

##### Parameters #########
passi = 2
##### Parameters #########
countrys = as.factor(pisa_data$CNT)
pisa_data = pisa_data[,model_variables]

pisa_data = as.data.frame(scale(pisa_data))
```
# Dataset completo- all countrys
```{r}
prova <- Rtsne(pisa_data,dim=2, perplexity=30, check_duplicates = FALSE, pca=FALSE)
plot(prova$Y[,1],prova$Y[,2],
   col=countrys, 
   main = paste( model_variables[i],"Perplexity = 30 (darker is better)"),
   pch =19)
legend("topright", legend = unique(countrys), col = unique(as.numeric(countrys)),ncol=2)
```

# Dataset completo
```{r}
for (i in 1:length(model_variables) ){

scelta = model_variables[i]
print(scelta)

	group_ordered <- with(pisa_data,                      
                  reorder(countrys,
                          pisa_data[,scelta],
                          FUN=mean,
                  		decreasing = T))
	
	medie = tapply(pisa_data[,scelta],group_ordered,mean)
	end = length
	differenze_discrete = round(medie[1:end(medie)-1] - medie[2:end(medie)],digits=4)
	differenze_discrete = round(as.data.frame(differenze_discrete),digits=4)$differenze_discrete

	max1 = max(differenze_discrete)
	max2 = max(setdiff(differenze_discrete,max1))
	massimi = c(max1)
	while( abs(which(differenze_discrete==max1)-which(differenze_discrete==max2))<=passi ){
		massimi = c(massimi,max2)
		max2 = max(setdiff(differenze_discrete,massimi))
	}
	v1=which(differenze_discrete==max1)
	v2=which(differenze_discrete==max2)
	
	good = (rownames(data.frame(medie))[1:min(v1,v2)])

	bad= (rownames(data.frame(medie))[max(v1,v2):end(medie)])
	plot(prova$Y[,1],prova$Y[,2],
     col=ifelse(countrys %in% good,cols[1],ifelse(countrys %in% bad,cols[3],cols[2])), 
     main = paste( model_variables[i],"Perplexity = 30 (darker is better)"),
     pch =19)
}
```
# Dataset tagliato in base alla categoria
```{r}
names_group = names(categories_variables_filtered)
for(k in 1:5){
  model_vars_grouped = categories_variables_filtered[[k]]
  pisa_data_group = pisa_data[,model_vars_grouped]

	if(length(model_vars_grouped)>2)
    prova <- Rtsne(pisa_data_group,dim=2, perplexity=50, check_duplicates = FALSE, pca=FALSE)
  if(length(model_vars_grouped)!=1){
      for (i in 1:length(model_vars_grouped) ){
  
      scelta = model_vars_grouped[i]

  	  group_ordered <- with(pisa_data_group,                      
                    reorder(countrys,
                            pisa_data_group[,scelta],
                            FUN=mean,
                    		decreasing = T))
  	
  	medie = tapply(pisa_data_group[,scelta],group_ordered,mean)
  	end = length
  	differenze_discrete = round(medie[1:end(medie)-1] - medie[2:end(medie)],digits=4)
  	differenze_discrete = round(as.data.frame(differenze_discrete),digits=4)$differenze_discrete
  
  	max1 = max(differenze_discrete)
  	max2 = max(setdiff(differenze_discrete,max1))
  	massimi = c(max1)
  	while( abs(which(differenze_discrete==max1)-which(differenze_discrete==max2))<=passi ){
  		massimi = c(massimi,max2)
  		max2 = max(setdiff(differenze_discrete,massimi))
  	}
  	v1=which(differenze_discrete==max1)
  	v2=which(differenze_discrete==max2)
  	
  	good = (rownames(data.frame(medie))[1:min(v1,v2)])
  
  	bad= (rownames(data.frame(medie))[max(v1,v2):end(medie)])
  	if(length(model_vars_grouped)>2){
  	   plot(prova$Y[,1],prova$Y[,2],
         col=ifelse(countrys %in% good,cols[1],ifelse(countrys %in% bad,cols[3],cols[2])), 
         main = paste( paste(names_group[k],model_vars_grouped[i]),"Perplexity = 50 (darker is better)"),
         pch =19)
  	    
  	}else if (length(model_vars_grouped)==2){
  	  plot(pisa_data_group[,model_vars_grouped],
        col=ifelse(countrys %in% good,cols[1],ifelse(countrys %in% bad,cols[3],cols[2])), 
        main = paste( paste(names_group[k],model_vars_grouped[i]),"Perplexity = 50 (darker is better)"),
        pch =19)
  	}

  }
  }

}
```



# plot vecchio
```{r}
#x11()
countrys_num <- as.numeric(countrys)
plot(tsne_results$Y[,1],tsne_results$Y[,2],col=countrys_num, main = "Perplexity = 30",
     pch =(countrys_num+10))
legend("topright", legend = unique(countrys), col = unique(countrys_num), pch =
         unique(countrys_num+10),ncol=2)
```


```{r}
tsne_results_3d <- Rtsne(pisa_data_cut,dim=3, perplexity=30, check_duplicates = FALSE, pca=FALSE)

plot3d(tsne_results_3d$Y, pch = 19, cex = 2, col = countrys_num, main = "Perplexity = 30")

```


