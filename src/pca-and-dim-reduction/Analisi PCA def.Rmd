---
title: "PISA dataset na exploration"
output: 
editor_options: 
  chunk_output_type: inline
---

# Map for variable meaning
```{r}
source("../include/Utilities.R")
```


# Setup
```{r}
#variabili finite nel dataset
tec=c("ICTCLASS","ICTHOME","ICTOUTSIDE","ICTRES","AUTICT","COMPICT","INTICT","ENTUSE","HOMESCH","USESCH")
psi=c("PERCOMP","PERCOOP","ATTLNACT","EMOSUPS","COMPETE","EUDMO","GFOFAIL","SWBP","RESILIENCE","BELONG","BEINGBULLIED","PERFEED")
clt=c("STUBEHA","JOYREAD","SCREADCOMP","HEDRES","CULTPOSS","LMINS","MMINS")
fam=c("WEALTH","ESCS","HOMEPOS","BFMJ2","BMMJ1","HISCED","HISEI")
tch=c("TEACHINT","TEACHSUP","STIMREAD","PROAT5AB","PROAT5AM","PROAT6","TEACHBEHA")
sch=c("ICTSCH","RATCMP1","STRATIO","SCHSIZE","CLSIZE","CREACTIV","EDUSHORT","STAFFSHORT")

## Da fare: spezzare quelle categorie in sotto gruppi, magari anche mischiati? per cercare di riassumere
## più variabili in una/due sola/sole, tramite pca

df=read.csv("../../data/pisa_wPV_grouped_bysch.csv")
colnames(df)
library(dplyr)
df=df[,-c(1,2,3)] #remove X (index) column
df <- df %>% select(-starts_with("PV")) #excluding target variables 
colnames(df)

want_to_plot_all_couples=0
want_to_save_score_df=0

sort(colnames(df[,-c(52)]))==sort(c(tec,psi,clt,fam,tch,sch))
#c'è tutto ora

df_tec = df[,colnames(df) %in% tec]
df_psi = df[,colnames(df) %in% psi]
df_clt = df[,colnames(df) %in% clt]
df_fam = df[,colnames(df) %in% fam]
df_tch = df[,colnames(df) %in% tch]
df_sch = df[,colnames(df) %in% sch]
```

# States - skip this part
not really useful
```{r}
states = unique(df$CNT)
states
len = length(unique(df$CNT))
len
hcl.pals()
col.ramp = hcl.colors(len, palette = "viridis")
```

## SWBP for states
## Comparison of the means in states
```{r}
psi=c("ATTLNACT","EMOSUPS","COMPETE","EUDMO","GFOFAIL","SWBP","RESILIENCE","BELONG","BEINGBULLIED","PERFEED")
for (val in psi){
	print(what_is[[val]])
}
# pos_val =c("ATTLNACT","EMOSUPS","COMPETE","EUDMO","SWBP","RESILIENCE","BELONG","PERFEED")
# neg_val =c("GFOFAIL","BEINGBULLIED")

# plot(df$SWB[which(df$CNT==state)] ~ df$schID[which(df$CNT==state)], main=paste("SWBP for the schools in",state))
vec_medie = rep(0,length(unique(states)))
it=0
for(state in states){
	vec_medie[it] = mean(df$SWB[which(df$CNT==state)])
	it=it+1
}
length(vec_medie)
length(states)
delta=1/20
plot(1:length(unique(states)),vec_medie, main="SWBP mean in states, by-school dataset",
	 ylim=c(min(vec_medie),max(vec_medie)+delta), col=col.ramp, pch=19)
x=1
for(state in states){
	text(x,vec_medie[x]+delta,state)
	x=x+1
}

states
```



Quella fatta prima era un po' fuffa riguardante manova o altre cose.
Ora inizia davvero la PCA.

# PCA on categories
```{r}
# prepariamo il dataset in cui salvare gli score
df_sc = NULL
```

## tec - FATTO
```{r}
tec=c("ICTCLASS","ICTHOME","ICTOUTSIDE","ICTRES","AUTICT","COMPICT","INTICT","ENTUSE","HOMESCH","USESCH")
tec_1 = c("ICTCLASS","ICTOUTSIDE") # uso informaticca a scuola
tec_2 = c("ICTHOME","ICTRES") # quantità
tec_3 = c("AUTICT","COMPICT","INTICT","ENTUSE","HOMESCH") # personal relation
for(i in tec){
	print(paste(i))
	dimmi(i)
	print(paste(""))
}
num_gruppi=3

df_tec_1 = df[,colnames(df) %in% tec_1]
df_tec_2 = df[,colnames(df) %in% tec_2]
df_tec_3 = df[,colnames(df) %in% tec_3]
```

```{r}
for(it in 1:num_gruppi){
	if(it==1){ cat_curr_vec = tec_1; cat_curr_name = "tec_1"; df_curr = df_tec_1 }
	if(it==2){ cat_curr_vec = tec_2; cat_curr_name = "tec_2"; df_curr = df_tec_2 }
	if(it==3){ cat_curr_vec = tec_3; cat_curr_name = "tec_3"; df_curr = df_tec_3 }

###############################################################################
colnames(df_curr)
# boxplot(df_curr, las=2)
want_to_scale=1

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}
par(mfrow=c(1,1))

###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=paste('Loadings PC ',i,sep=''),las=2)
}
```

### Scores dataset
```{r}
df_sc = pca$scores[,1:4]
colnames(df_sc) = c("scPC1_tec","scPC2_tec","scPC3_tec","scPC4_tec")
```

### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# PC1 seems to collect the amount of tecnology in which lo studente si ritrova immerso
# -> PC1 alta -> alta disponibilità di tecnologia
# 
# PC2 seems to contrast il mero uso della tecnologia (a scuola, casa, nelle lezioni, ecc)
# contro il vero interesse/dedizione dello studente per la tecnologia (vedi le tre variabili negative)
# -> PC2 bassa -> gli studenti sono molto interessati alla tecnologia malgrado la poca disponibilità
# -> PC2 alta -> gli studenti avrebbero anche molta tecnologia a disposizione ma non sembrano interessati/bravi
# 
```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}

```

### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)
	}
}
}
```


## psi
```{r}
psi=c("PERCOMP","PERCOOP","ATTLNACT","EMOSUPS","COMPETE","EUDMO","GFOFAIL","SWBP","RESILIENCE","BELONG","BEINGBULLIED","PERFEED")
psi_1 = c("GFOFAIL","EMOSUPS","BELONG","BEINGBULLIED","PERFEED") # sociale
psi_2 = c("COMPETE","RESILIENCE","ATTLNACT") # caratteriale
psi_3 = c("EUDMO","SWBP")
for(i in psi){
	print(paste(i))
	dimmi(i)
	print(paste(""))
}
num_gruppi=3

df_psi_1 = df[,colnames(df) %in% psi_1]
df_psi_2 = df[,colnames(df) %in% psi_2]
df_psi_3 = df[,colnames(df) %in% psi_3]

ggcorr(select_if(df[,psi],is.numeric),label=TRUE,label_size = 2)

```


```{r}
for(it in 1:num_gruppi){
	if(it==1){ cat_curr_vec = psi_1; cat_curr_name = "psi_1"; df_curr = df_psi_1 }
	if(it==2){ cat_curr_vec = psi_2; cat_curr_name = "psi_2"; df_curr = df_psi_2 }
	if(it==3){ cat_curr_vec = psi_3; cat_curr_name = "psi_3"; df_curr = df_psi_3 }

###############################################################################
colnames(df_curr)
# boxplot(df_curr, las=2)
want_to_scale=1

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}

par(mfrow=c(1,1))


###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=paste('Loadings PC ',i,sep=''),las=2)
}
```

### Scores datasets
```{r}
dim(df_sc)
names= c(colnames(df_sc),"scPC1_psi","scPC2_psi","scPC3_psi","scPC4_psi","scPC5_psi","scPC6_psi")
df_sc = cbind(df_sc, pca$scores[,1:6])
colnames(df_sc) = names
```


### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# PC1 sembra fare la somma dei contributi positivi contro quelli negativi: cioè tutti
# sommati tranne gfofail e beingbullied
# -> PC1 alta -> gli studenti stanno molto bene
#
# PC2 sembra un po' difficile da interpretare. Forse
# pc2 bassa -> gli studenti se la cavano bene da soli (percepiscono buoni feedback, acquistano
# resilienza, magari dopo essere bullizzati, e competitvità e fiducia nella vita)
```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}

```

### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}	 
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)
	}
}
}
```

## clt - FATTO
```{r}
clt=c("STUBEHA","JOYREAD","SCREADCOMP","HEDRES","CULTPOSS","LMINS","MMINS")
clt_1= c("JOYREAD","HEDRES","CULTPOSS")
clt_2 = c("LMINS","MMINS")
# scartate STUBEHA e SCREADCOMP, magari quelle meglio includerle in psi
	  
for(i in clt){
	print(paste(i))
	dimmi(i)
	print(paste(""))
}
num_gruppi=3

df_clt_1 = df[,colnames(df) %in% clt_1]
df_clt_2 = df[,colnames(df) %in% clt_2]
df_clt_3 = df[,colnames(df) %in% clt_3]
# df_clt_4 = df[,colnames(df) %in% clt_4]

ggcorr(select_if(df[,clt],is.numeric),label=TRUE,label_size = 2)

```


```{r}
for(it in 1:num_gruppi){
	if(it==1){ cat_curr_vec = clt_1; cat_curr_name = "clt_1"; df_curr = df_clt_1 }
	if(it==2){ cat_curr_vec = clt_2; cat_curr_name = "clt_2"; df_curr = df_clt_2 }
	if(it==3){ cat_curr_vec = clt_3; cat_curr_name = "clt_3"; df_curr = df_clt_3 }
	if(it==4){ cat_curr_vec = clt_4; cat_curr_name = "clt_4"; df_curr = df_clt_4 }

###############################################################################
colnames(df_curr)
# df_new = df_curr
# df_new$LMINS = log(df_curr$LMINS+1)
# df_new$MMINS = log(df_curr$MMINS+1)
# boxplot(df_new)
# df_curr = df_new
# non cambia molto la pca
want_to_scale=1

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
boxplot(df2, las=2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}
par(mfrow=c(1,1))

###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=paste('Loadings PC ',i,sep=''),las=2)
}
```

### Scores datasets
```{r}
dim(df_sc)
names= c(colnames(df_sc),"scPC1_clt","scPC2_clt","scPC3_clt","scPC4_clt")
df_sc = cbind(df_sc, pca$scores[,1:4])
colnames(df_sc) = names
```

### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# pc1 alta -> gli studenti hanno molta cultura nel senso di lettura
# pc1 bassa -> gli studenti spendono più tempo nello studio effettivo che nel leggere per cultura
# 
# pc2 alta -> gli studenti dedicano molto tempo allo studio ma comunque apprezzano anche la lettura
# tipo per proprio diletto

```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}


```
### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}	
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)
	}
}
}
```

## fam - FATTO
```{r}
cat_curr_vec = fam
cat_curr_name = "fam"
df_curr = df_fam

###############################################################################
colnames(df_curr)
want_to_scale=1

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
boxplot(df2, las=2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}

###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=paste('Loadings PC ',i,sep=''),las=2)
pca$loadings
summary(pca)
```

### Scores datasets
```{r}
dim(df_sc)
names = c(colnames(df_sc),"scPC1_fam")
df_sc = cbind(df_sc, pca$scores[,1])
colnames(df_sc) = names

```

### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# ISEI is an International Socio-Economic Index of occupational status


# pc1 fa una media di tutto, quindi 
# pc1 alta -> tutto va bene in famiglia, almeno a livello economico
# 
# pc2 fa contrasto tra possessioni materiali (wealth, homeposs) e culturali
# -> pc2 bassa (intesa naturalmente anche come <0) -> maggiore peso culturale
# -> pc2 alta -> la famiglia è più facoltosa nella realtà di quanto non magari culturalmente buona
```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}


```

### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)
	}
}
}
```

## tch - FORSE FATTO
```{r}
tch=c("TEACHINT","TEACHSUP","STIMREAD","PROAT5AB","PROAT5AM","PROAT6","TEACHBEHA")
tch_1 = c("TEACHINT","TEACHSUP","STIMREAD","TEACHBEHA")
tch_2 = c("PROAT5AB","PROAT5AM","PROAT6")

for(i in tch){
	print(paste(i))
	dimmi(i)
	print(paste(""))
}
num_gruppi=2

df_tch_1 = df[,colnames(df) %in% tch_1]
df_tch_2 = df[,colnames(df) %in% tch_2]

```


```{r}
for(it in 1:num_gruppi){
	if(it==1){ cat_curr_vec = tch_1; cat_curr_name = "tch_1"; df_curr = df_tch_1 }
	if(it==2){ cat_curr_vec = tch_2; cat_curr_name = "tch_2"; df_curr = df_tch_2 }


###############################################################################
colnames(df_curr)
want_to_scale=0

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
boxplot(df2, las=2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}
par(mfrow=c(1,1))
###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=paste('Loadings PC ',i,sep=''),las=2)
}
```


### Scores datasets
```{r}
dim(df_sc)
names = c(colnames(df_sc),"scPC1_tch","scPC2_tch","scPC3_tch")
df_sc = cbind(df_sc, pca$scores[,3])
colnames(df_sc) = names

```

### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# pc1 fa una media dei vari contributi
# -> pc1 alta -> grande supporto dei prof per gli studenti
# 
# pc2 fa contrasto tra eh, queste variabili non hanno una spiegazione molto chiara. Forse
# -> pc2 alta -> il prof supporta molto i suoi studenti, ma in modo più pratico
# -> pc2 bassa (naturalmente anche <0) -> il prof dà più stimoli culturali (supporto alla lettura
# per esempio) che pratici
```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}

```
### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}				 
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)

	}
}
}
```
## sch
```{r}
sch=c("PERCOMP","PERCOOP","ICTSCH","RATCMP1","STRATIO","SCHSIZE","CLSIZE","CREACTIV","EDUSHORT","STAFFSHORT")

sch_1 = c("ICTSCH","RATCMP1","CLSIZE","EDUSHORT")
sch_2 = c("SCHSIZE","STRATIO","CREACTIV","STAFFSHORT")

for(i in sch){
	print(paste(i))
	dimmi(i)
	print(paste(""))
}
num_gruppi=2

df_sch_1 = df[,colnames(df) %in% sch_1]
df_sch_2 = df[,colnames(df) %in% sch_2]
df_sch_3 = df[,colnames(df) %in% sch_3]
# df_sch_4 = df[,colnames(df) %in% sch_4]

ggcorr(select_if(df[,sch],is.numeric),label=TRUE,label_size = 2)
```


```{r}
for(it in 1:num_gruppi){
	if(it==1){ cat_curr_vec = sch_1; cat_curr_name = "sch_1"; df_curr = df_sch_1 }
	if(it==2){ cat_curr_vec = sch_2; cat_curr_name = "sch_2"; df_curr = df_sch_2 }
	if(it==3){ cat_curr_vec = sch_3; cat_curr_name = "sch_3"; df_curr = df_sch_3 }
	if(it==4){ cat_curr_vec = sch_4; cat_curr_name = "sch_4"; df_curr = df_sch_4 }

###############################################################################
colnames(df_curr)
want_to_scale=1

if(want_to_scale==1){
  df2 = scale(df_curr[,])
} else{
  df2 = df_curr
}
df2 = data.frame(df2)
boxplot(df2, las=2)
df2["CNT"] = df$CNT
df_pca = df2
head(df_pca)
#now CNT is the last one purtroppo

pca = princomp(df_pca[,1:dim(df_pca)[2]-1])
summary(pca)

###############################################################################
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)

print("loadings plot")
sort(pca$loadings[,1]) #test soglia
quantile(pca$loadings[,1],0.8) #test soglia
mean(pca$loadings[,1]) #test soglia
median(pca$loadings[,1]) #test soglia

###############################################################################
par(mfrow=c(2,1))
for(i in 1:2){
  # soglia = quantile(pca$loadings[,i],0.6)),i]
  soglia = 0
  barplot(
      # pca$loadings[which(abs(pca$loadings[,i])>0.02),i],
      # pca$loadings[which(abs(pca$loadings[,i])>soglia)],
      pca$loadings[,i],
      main=paste('Loadings PC',i),las=2
      )
      # pca$loadings[which(abs(pca$loadings[,i])>mean(pca$loadings[,i]))])
}
par(mfrow=c(1,1))

###############################################################################
# higher pcs
# par(mar = c(2,2,2,1), mfrow=c(3,1))
# for(i in 3:5)barplot(pca$loadings[,i], ylim = c(-1, 1),
# main=pasteLoadings PC ',i,sep=''),las=2)
}
```



### Scores datasets
```{r}
dim(df_sc)
names = c(colnames(df_sc),"scPC1_sch","scPC2_sch")
df_sc = cbind(df_sc, pca$scores[,1:2])
colnames(df_sc) = names

```


### Interpretation
```{r}
for (col in cat_curr_vec){
  print(paste(col,what_is[[col]]))
}
# pc1 alta -> buono clima nella scuola? (alta competitività, ma anche cooperazione, e ICT available)
# pc2 sembra invece contrastare il contesto sociale con quello tecnologico
# pc2 alta -> la scuola ha un bel clima sociale
# pc2 bassa -> la scuola ha un contesto più ricco sul lato tecnologico (quindi peggio dal lato umano forse) 
```

### Scores plot
```{r}
i=0
for (x in unique(df$CNT)) {
  # print(x)
  if (i%%2==0) { par(mfrow=c(1,2))  }
  i=i+1
  plot(pca$scores[which(df$CNT==x),1:2],main = paste0(toupper(cat_curr_name),": ",x))
       # xlab = paste(cat_curr_name,"Comp.1"),ylab = paste(cat_curr_name,"Comp.2"))
  abline(h=0, v=0, lty=2, col='grey')
  points(0,0,pch=19,cex=1.4,col="orange")
}

```

### Scores plot on all couple of states
```{r}
if(want_to_plot_all_couples==1){
# colp = hcl.colors(2,palette="Terrain")
colp=c("lightblue","purple")

for (i in 1:length(states)) {
	for (j in i:length(states)) {
		if(i==j){
			next
		}			 
		plot(pca$scores[which(df$CNT==states[i]),1:2],main = paste0(toupper(cat_curr_name),": ",states[i], " vs ", states[j]),
			 col=colp[1],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")	
		
		points(pca$scores[which(df$CNT==states[j]),1:2],
   			 col=colp[2],pch=19, 
			 xlim=c(min(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1]),
			 	   max(pca$scores[which(df$CNT==states[i]),1],
			 		    pca$scores[which(df$CNT==states[j]),1])),
			ylim=c(min(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2]),
			 	   max(pca$scores[which(df$CNT==states[i]),2],
			 		    pca$scores[which(df$CNT==states[j]),2])),
			 )
		abline(h=0, v=0, lty=2, col='grey')
		points(0,0,pch=19,cex=1.4,col="orange")
		
		legend("bottomleft",c(states[i],states[j]), fill=colp, bty='n', cex = 0.7)
	}
}
}
```




# Write the score dataset
```{r}
if(want_to_save_score_df==1){
	dim(df)
	dim(df_sc)
	# PCs selected
	
	df_sc_with_cnt=cbind(df$CNT,df_sc)
	names=colnames(df_sc)
	colnames(df_sc_with_cnt) = c("CNT",names)
	df_sc_with_cnt
	
	# and the oscar to the longest name goes to...
	write.csv(data.frame(df_sc_with_cnt),"../../data/pisa_school_final_wo_Outl_PCA_SCORES.csv")
	head(data.frame(df_sc_with_cnt))
}
```









# Andrews plot, piccolo intermezzo
```{r}
# install.packages("pracma")
library(pracma)
len_states=length(states)
len_psi=length(psi)
A=matrix(nrow = len_states, ncol = len_psi)
# A[,1]=states # morally


for(i in 1:len_states){
	for(j in 1:len_psi){
		A[i,j]=mean(df[which(df$CNT==states[i]),psi[j]])
	}
}
andrewsplot(A, f=as.factor(states), style = "pol", scaled = FALSE, npts = 101)
andrewsplot(A, f=as.factor(states), style = "cart", scaled = FALSE, npts = 101)
# ci fosse la legenda, ma andrewsplot non sembra implementarla, quindi i colori boh
```


