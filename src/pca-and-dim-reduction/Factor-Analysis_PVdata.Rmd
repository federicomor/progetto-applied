---
title: "Factor Analysis"
output: 
---

# NOTES AND REFERENCES

-   Exploratory Factor Analysis (EFA) tutorial: <https://rpubs.com/pjmurphy/758265>

-   notes from the textbook "Applied Multivariate Statistical Analysis" in the same directory of this folder

-   reference paper of past year project on Well-Being

-   source: <https://www.geo.fu-berlin.de/en/v/soga/Geodata-analysis/factor-analysis/A-simple-example-of-FA/index.htmlZ>

-   according to this article (<https://journals.sagepub.com/doi/full/10.1177/0095798418771807>) it is better to perform EFA only on variables we suspect to be generated by a latent factor. Thus, it is better to follow the same procedure we used for PCA

# PRELIMINARY STUFF

```{r}
#loaded librarires
library(dplyr)
library(psych) #for KMO test and principal()
library(car) #to apply transformations
library(MVN) #to perform multivariate gaussianity check
library(GGally) #for ggcorr
library(ggplot2)
library(elasticnet) #trying out sparse principal component analysis [spca()]
```

```{r, setup}
#DIRECTORIES
root_proj_dir = "../../"
dataset_dir = paste(root_proj_dir,"/data/pisa_wPV_grouped_bysch.csv",sep="")
include_dir = paste(root_proj_dir,"/src/include/Utilities.R",sep="")
#INCLUDING UTILITIES
source(include_dir)
#IMPORTING THE DATASET
pisa_data <- read.csv(file=dataset_dir)
```

```{r}
#some adjustments on the data
pisa_data$X <- NULL
pisa_data$schID <- NULL
pisa_data$CNT <- as.factor(pisa_data$CNT)
pisa_data$CNTSCHID <- as.factor(pisa_data$CNTSCHID)
pisa_data$CNTSTUID <- as.factor(pisa_data$CNTSTUID)
```

# PREPROCESSING OF DATA

Saving plausible values in a separate dataframe. Later we'll add them to the scores dataset

```{r}
#paluesible values dataset
plausible_values <- pisa_data %>% select(starts_with("PV"))
#excluding PV frmo the dataset to compute the factor analysis
pisa_data <- pisa_data %>% select(-starts_with("PV")) #excluding target variables
```

```{r}
#standardize the variables
transformed_data <- as.data.frame(scale(select_if(pisa_data,is.numeric)))
transformed_data$CNT <- pisa_data$CNT #adding CNT column

pisa_data <- transformed_data
rm(transformed_data)
```

Quick look at the data

```{r}
boxplot(select_if(pisa_data,is.numeric),las=2)
```

# GROUPING THE VARIABLES

Grouping variables suspected to be generated by a latent factor (The same variable may appear in more than one group, according to our choices):

-   technological field (tec):

    -   ICTCLASS: Subject-related ICT use during lessons (WLE)

    -   ICTOUTSIDE: Subject-related ICT use outside of lessons (WLE)

    -   ICTHOME: ICT available at home [-\> family]

    -   ICTRES: Subject-related ICT use outside of lessons (WLE)

    -   AUTICT: Perceived autonomy related to ICT use (WLE)

    -   COMPICT: Perceived ICT competence (WLE)

    -   INTICT: Interest in ICT (WLE)

    -   ENTUSE: ICT use outside of school (leisure) (WLE)

    -   HOMESCH: Use of ICT outside of school (for school work activities) (WLE)

    -   USESCH: Use of ICT at school in general (WLE)

    -   ICTSCH: ICT available at school [-\> school]

    -   RATCMP1: Number of available computers per student at modal grade [-\> school]

-   Psychological field (psi):

    -   ATTLNACT: Attitude towards school: learning activities (WLE)

    -   EMOSUPS: Parents' emotional support perceived by student (WLE) -\> also in family

    -   COMPETE: Competitiveness (WLE)

    -   EUDMO: Eudaemonia: meaning in life (WLE)

    -   GFOFAIL: General fear of failure (WLE)

    -   SWBP: Subjective well-being: Positive affect (WLE) -\> according to wikipedia: **Positive affectivity**Â (**PA**) is a human characteristic that describes how much people experience positive affects (sensations, emotions, sentiments); and as a consequence how they interact with others and with their surroundings. (<https://en.wikipedia.org/wiki/Positive_affectivity>)

    -   RESILIENCE: Resilience (WLE)

    -   BELONG: Subjective well-being: Sense of belonging to school (WLE)

    -   BEINGBULLIED: Student's experience of being bullied (WLE)

    -   PERFEED: Perceived feedback (WLE)

-   Cultural and educational field (clt):

    -   JOYREAD: Joy/Like reading (WLE)

    -   CULTPOSS: Cultural possessions at home (WLE) -\> family

    -   HEDRES: Home educational resources (WLE) -\> family

    -   SCREADCOMP: Self-concept of reading: Perception of competence (WLE)

    -   LMINS: Learning time (minutes per week) - \<test language\>

    -   MMINS: Learning time (minutes per week) - \<Mathematics\>

-   Family (fam): economic and cultural point of view

    -   WEALTH: Family wealth (WLE)

    -   ESCS: Index of economic social and cultural status

    -   HOMEPOS: Home possessions (WLE)

    -   HISCED: Highest Education of parents

    -   HISEI: Index highest parental occupational status

    -   CULTPOSS: Cultural possessions at home (WLE) -\>culture

    -   HEDRES: Home educational resources (WLE) -\> culture

    -   ICTHOME: ICT available at home -\> technology

-   Teaching (tch): (maybe here we could add some variables from the teachers questionnaire)

    -   TEACHINT: Perceived teacher's interest (WLE)

    -   TEACHSUP: Teacher support in test language lessons (WLE)

    -   STIMREAD: Teacher's stimulation of reading engagement perceived by student (WLE)

    -   PROAT5AB Index proportion of all teachers ISCED LEVEL 5A Bachelor

    -   PROAT5AM Index proportion of all teachers ISCED LEVEL 5A Master

    -   PROAT6 Index proportion of all teachers ISCED LEVEL 6

    -   TOTAT Total number of all teachers at school

    -   TEACHBEHA Teacher behaviour hindering learning (WLE)

-   School (sch): (maybe here we could add some variables from the school questionnaire)

    -   PERCOMP: Perception of competitiveness at school (WLE)

    -   PERCOOP: Perception of cooperation at school (WLE)

    -   ICTSCH: ICT available at school -\> also in tech group

    -   RATCMP1: Number of available computers per student at modal grade -\> also in tech group

    -   SCHLTYPE: School Ownership

    -   STRATIO Student-Teacher ratio

    -   SCHSIZE School Size (Sum)

    -   CLSIZE Class Size

    -   CREACTIV Creative extra-curricular activities (Sum)

    -   EDUSHORT Shortage of educational material (WLE)

    -   STAFFSHORT Shortage of educational staff (WLE)

    -   STUBEHA Student behaviour hindering learning (WLE)

```{r}
#variabili finite nel dataset
group_list <- c("tec","psi","clt","fam","tch","sch")
grouped_variables <-list()
#list of grouped variables
grouped_variables[["tec"]] <- c("ICTCLASS","ICTHOME","ICTOUTSIDE","ICTRES","AUTICT","COMPICT","INTICT","ENTUSE","HOMESCH","USESCH", "ICTSCH","RATCMP1")
grouped_variables[["psi"]] <- c("ATTLNACT","EMOSUPS","COMPETE","EUDMO","GFOFAIL","SWBP","RESILIENCE","BELONG","BEINGBULLIED","PERFEED")
grouped_variables[["clt"]] <- c("JOYREAD","CULTPOSS","HEDRES","SCREADCOMP","LMINS","MMINS","STUBEHA")
grouped_variables[["fam"]] <- c("WEALTH","ESCS","HOMEPOS","BFMJ2","BMMJ1","HISCED","HISEI","CULTPOSS","HEDRES","ICTHOME")
grouped_variables[["tch"]] <- c("TEACHINT","TEACHSUP","STIMREAD","PROAT5AB","PROAT5AM","PROAT6","TEACHBEHA")
grouped_variables[["sch"]] <- c("PERCOMP","PERCOOP","ICTSCH","RATCMP1","STRATIO","SCHSIZE","CLSIZE","CREACTIV","EDUSHORT","STAFFSHORT")
```

Some graphs to validate the choice made while grouping the variables

```{r}
#OVERALL CORRELATION OVERVIEW
ggcorr(select_if(pisa_data,is.numeric),label=TRUE,label_size = 2)

#WITHIN GROUPS
#tec
ggcorr(select_if(pisa_data[,grouped_variables[["tec"]]],is.numeric),label=TRUE,label_size = 2)
#psi
ggcorr(select_if(pisa_data[,grouped_variables[["psi"]]],is.numeric),label=TRUE,label_size = 2)
#clt
ggcorr(select_if(pisa_data[,grouped_variables[["clt"]]],is.numeric),label=TRUE,label_size = 2)
#fam
ggcorr(select_if(pisa_data[,grouped_variables[["fam"]]],is.numeric),label=TRUE,label_size = 2)
#tch
ggcorr(select_if(pisa_data[,grouped_variables[["tch"]]],is.numeric),label=TRUE,label_size = 2)
#sch
ggcorr(select_if(pisa_data[,grouped_variables[["sch"]]],is.numeric),label=TRUE,label_size = 2)
```

# PERFORMING EFA

Preliminary tests:

-   cortest.bartlett(): test to see if the variables in the dataframe are uncorrellated. H0: correlation matrix sigma = Identity matrix (i.e. uncorrellated variables)

-   KMO: another check on uncorrelation

-   multivariate normality to perform factor analysis with the maximum likelihood estimation method

```{r}
checking_hp <- list()
for(group in group_list){
  #(1) CORRELATION
  #KMO(select_if(pisa_data[,included_variables[[group]]],is.numeric))
  checking_hp[[group]]$correlation <- cortest.bartlett(select_if(pisa_data[,grouped_variables[[group]]],is.numeric))
  #(2) MULTIVARIATE NORMALITY
  checking_hp[[group]]$normality <- mvn(data = select_if(pisa_data[,grouped_variables[[group]]],is.numeric), mvnTest = "hz",univariateTest = "SW")
}
```

Selecting the number of factor to select:

the following methods are useful to select the initial number of factors. The final choice should be made based on the portion of variance explained

```{r}
#eigenvalues method
for(group in group_list){
  #scree plot
  scree(select_if(pisa_data[,grouped_variables[[group]]],is.numeric), 
        pc=TRUE, 
        main = paste("Scree plot", group))
  #parallel analysis
  #fa.parallel(select_if(pisa_data[,grouped_variables[[group]]],is.numeric), 
  #            fa="fa", 
  #           main = paste("Parallel Analysis Scree Plots",group))
  #a method from psych package with many more criteria
  #nfactors(cor(select_if(pisa_data[,grouped_variables[[group]]],is.numeric)),
  #         title = paste("Number of factors", group))
}
```

```{r}
#storing the number of factors (decision based on the previous plots)
nfactors <- list()
#tec
nfactors[["tec"]]$PC <- 6
nfactors[["tec"]]$FA <- 3
#psi
nfactors[["psi"]]$PC <- 5
nfactors[["psi"]]$FA <- 2
#clt
nfactors[["clt"]]$PC <- 4 
nfactors[["clt"]]$FA <- 3
#fam
nfactors[["fam"]]$PC <- 3 
nfactors[["fam"]]$FA <- 2 
#tch
nfactors[["tch"]]$PC <- 4 
nfactors[["tch"]]$FA <- 3
#sch
nfactors[["sch"]]$PC <- 6 
nfactors[["sch"]]$FA <- 3
```

Options:

-   factanal(): performs a EFA by maximum likelihood estimation [package stats]

-   princomp(): perform PCA in the stadard way, as seen in lecture [package stats]

-   fa(): performs various types of EFA, we can decided the most suited one [package psych]

-   principal(): performs PCA in a more sophisticated way, see the doxumentation in this folder [package psych]

```{r}
#TRIED methods:
# FA with ML
fit_FA_ML <- list() #factanal() 

# classical PCA 
fit_PCA_classic <- list() #princomp()

# FA with OLS method
fit_FA_OLS <- list() #fa() 

# advanced PCA
fit_PCA_advanced <- list()

#fitting the models
for(group in group_list){
  #FA with ML
  fit_FA_ML[[group]] <- factanal(x = select_if(pisa_data[,grouped_variables[[group]]],is.numeric),
                                 factors = nfactors[[group]]$FA, 
                                 rotation = "promax", 
                                 lower = 0.0057)
  #classic PCA
  fit_PCA_classic[[group]] <- princomp(select_if(pisa_data[,grouped_variables[[group]]],is.numeric))
  #FA with OLS
  fit_FA_OLS[[group]] <- fa(r = cor(select_if(pisa_data[,grouped_variables[[group]]],is.numeric)),
                            nfactors = nfactors[[group]]$FA,
                            rotate = "oblimin")
  #advanced PCA
  fit_PCA_advanced[[group]] <- principal(r = cor(select_if(pisa_data[,grouped_variables[[group]]],is.numeric)),
                               nfactors = nfactors[[group]]$PC, 
                               rotate = "promax", 
                               scores = TRUE)
  
}
```

**A note on rotation:** loading matrix (L) is unique up to rotation made through orthogonal matrices. Thus, we have can provide as an option to this functions a rotation method to ease the interpretability of the loadings. There a two kind of rotations:

-   orthogonal rotation methods: if we assume that the extracted factors are independent

    -   "varimax": optimized to reduce cross loadings and to minimize smaller loading values, making factor models clearer

    -   "quartimax": works to reduce the number of variables needed to explain a factor, making interpretation easier

    -   "equamax": compromise between varimax and quartimax

-   oblique rotation methods: if we assume that the extracted factors are not independent

    -   "promax": Promax rotation is popular for its ability to handle large datasets efficiently. The approach also tends to result in greater correlation values between factors.

    -   The direct "oblimin" rotation approach is somewhat less efficient with large datasets, but can produce a simpler factor structure.

[reference: <https://rpubs.com/pjmurphy/758265> for]

# LOADINGS AND VARIANCE EXPLAINED

Variance explained:

```{r}
plot(cumsum(pca$sde^2)/sum(pca$sde^2), type='b', axes=F, xlab='Number of components',
     ylab='Contribution to the total variance', ylim=c(0,1),
     main=paste("Case of",cat_curr_name))
abline(h=1, col='blue')
abline(h=0.8, lty=2, col='blue')
box()
axis(2,at=0:10/10,labels=0:10/10)
axis(1,at=1:ncol(df_curr),labels=1:ncol(df_curr),las=2)
```

Visualizing the loadings:

```{r}
#Principal Component method
for(group in group_list){
  for(i in 1:dim(fit_FA_PC[[group]]$loadings)[2]){
    barplot(fit_FA_PC[[group]]$loadings[,i], main = paste("factor",group,i),las=2,cex.names=0.7)
  }
}
```

# EFA

```{r}
#Principal Component method
for(group in group_list){
  for(i in 1:dim(fit_FA_PC[[group]]$loadings)[2]){
    barplot(fit_FA_OLS[[group]]$loadings[,i], main = paste("factor",group,i),las=2,cex.names=0.7)
  }
}
```

## Classic PCA

```{r}
#BUG: I'M MISSING SOMETHING
for(group in group_list){
  print(summary(fit_classic_PC[[group]]))
}
```

```{r}
#Principal Component method
for(group in group_list){
  for(i in 1:dim(fit_classic_PC[[group]]$loadings)[2]){
    barplot(fit_classic_PC[[group]]$loadings[,i], main = paste("factor",group,i),las=2,cex.names=0.7)
  }
}
```

# COMPUTING THE SCORES

```{r}
#little utility to compute the scores from a fit of principal() and the dataframe on which the fit is computed
scores <- function(fit,data){
  return(as.data.frame(as.matrix(data)%*%fit$loadings))
}

#utiliy to name the dataframe
add_prefix <- function(prefix,x){
  return(paste(prefix,x,sep="_"))
}

FA_PC_scores <- data.frame(matrix(nrow = dim(pisa_data)[1], ncol = 0))
for(group in group_list){
  #score names
  PC_names <- as.character(1:nfactors[[group]])
  PC_names <- sapply(PC_names, add_prefix, prefix = group)
  PC_names <- sapply(PC_names, add_prefix, prefix = "PC")
  
  #computing the scores
  FA_PC_scores[,PC_names] <- scores(fit_FA_PC[[group]],select_if(pisa_data[,grouped_variables[[group]]],is.numeric))
}
```

Building and writing the score dataset:

```{r}
#add CNT column
FA_PC_scores$CNT <- pisa_data$CNT
#adding PVs
FA_PC_scores[,names(plausible_values)] <- plausible_values
```

```{r eval=FALSE, include=FALSE}
saving_dir <- "../../data"
write.csv(FA_PC_scores, file=paste(saving_dir,"pisa_wPV_PCscores.csv",sep="/"))
```
