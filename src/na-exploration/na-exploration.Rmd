---
title: "PISA dataset na exploration"
output: 
editor_options: 
  chunk_output_type: inline
---

# POOLS OF VARIABLES OF INTEREST

Selected variables from `selected_variables.txt`

Some details about the computation of the indexes [docs: <https://www.oecd-ilibrary.org/sites/0a428b07-en/index.html?itemId=/content/component/0a428b07-en>]

Complete vectors listing variables from each file (students, schools, teachers)

```{r}
#complete vectors
stu_vars = c("ICTCLASS","ICTHOME","ICTOUTSIDE","ICTRES","AUTICT","COMPICT","INTICT","ENTUSE","HOMESCH","USESCH","ATTLNACT","EMOSUPS","COMPETE","EUDMO","GFOFAIL","SWBP","RESILIENCE","BELONG","BEINGBULLIED","PERFEED","JOYREAD","CULTPOSS","HEDRES","SCREADCOMP","LMINS","MMINS","WEALTH","ESCS","HOMEPOS","BFMJ2","BMMJ1","HISCED","HISEI", "WEALTH","ESCS","HOMEPOS","BFMJ2","BMMJ1","HISCED","HISEI", "TEACHINT","TEACHSUP","STIMREAD", "PERCOMP","PERCOOP","ICTSCH")

sch_vars = c("SCHLTYPE","STRATIO","SCHSIZE","RATCMP1","PROATCE","PROAT5AB","PROAT5AM","PROAT6","CLSIZE","CREACTIV","EDUSHORT","STAFFSHORT","STUBEHA","TEACHBEHA","SCMCEG")

teach_vars = c("COLT","EXCHT","SATJOB","SATTEACH","SEFFCM","SEFFREL","SEFFINS","TCOTLCOMP","TCSTIMREAD","TCSTRATREAD","TCICTUSE","TCDISCLIMA","TCDIRINS","FEEDBACK","ADAPTINSTR","FEEDBINSTR")

```

Listing selected countries

```{r}
selected_countries = c("HRV","CZE","DNK","EST","FIN","FRA","GRC","HUN","IRL","LTU","LUX","POL","SVK","SVN","ESP","SWE")
```

# DATA LOADING

```{r}
#paths
dataset_path = "/Users/marcogalliani/Library/CloudStorage/OneDrive-PolitecnicodiMilano/Corsi/4.2 Applied Statistics/PISA-dataset/PISA_file_sav"
```

Instructions to merge data:

In order to run specific analysis, such as school level estimations, the PISA data files may need to be merged. (Please note that variable names can slightly differ across PISA cycles. The examples below are from the PISA 2015 database.)

-   To merge the *student data file* with the *school* or/and the *teacher data file*(s), use the country code 3-character (variable name: CNT in the PISA 2015 data file) and the international school ID (variable name: CNTSCHID in the PISA 2015 data file) for performing the merging process.

```{=html}
<!-- -->
```
-   To merge the *student data file* with the *parent data file*, use the country code 3-character (variable name: CNT in the PISA 2015 data file) and the international student ID (variable name: CNTSTUID in the PISA 2015 data file) for performing the merging process.

```{=html}
<!-- -->
```
-   To merge the *student data file* with the *cognitive or financial literacy data file(s)*, use the country code 3-character (variable name: CNT in PISA 2015), the international school ID (variable name: CNTSCHID in the PISA 2015 data file) and the international student ID (variable name: CNTSTUID in the PISA 2015 data file) variables for performing the merging process.

```{r}
library(foreign)
teacher_file <- read.spss(file = paste(dataset_path,"CY07_MSU_TCH_QQQ.sav",sep = "/"), 
                          use.value.labels = FALSE,
                          to.data.frame = TRUE)
```

Automatic loading by INTSVY package (doesn't work with teacher file)

```{r}
library(intsvy) # package to analyze PISA dataset

#selecting and merging
pisa_europe <- pisa.select.merge(folder= dataset_path,
                               school.file="CY07_MSU_SCH_QQQ.sav", 
                               student.file="CY07_MSU_STU_QQQ.sav",
                               student= stu_vars,
                               school = sch_vars,
                               countries = selected_countries)    
```

Cleaning some variables generated by intsvy package that we will not use in this analysis

-   Removing replicate weights

-   Averaging PV for some specific field

-   Removing IDs (except for school ID that we may use to group the variables), W_FSTUWT and W_FSTUWT_SC_SUM

```{r}
library(dplyr)
#remove replicate weights
pisa_europe <- pisa_europe %>% select(-starts_with("W_FSTU")) 
#removing IDs
pisa_europe <- pisa_europe %>% select(-c("CNTRYID","CNTSCHID","CNTSTUID","BOOKID")) 
```

```{r}
pisa_europe <- pisa_europe %>% select(-starts_with("PV"))
```

# GENERAL INSPECTION

Inspecting the presence of NAs

docs: <https://cran.r-project.org/web/packages/naniar/vignettes/naniar-visualisation.html>

```{r}
library(naniar)
library(ggplot2)
library(UpSetR)

inspect_df_NA <- function(df){
  plot1 <- vis_miss(df,warn_large_data = FALSE)    
  plot2 <- gg_miss_upset(df,nsets = 10)
  plot3 <- gg_miss_fct(x = df,fct = CNT)
  return(list(plot1,plot2,plot3))
}
```

```{r}
plots <- inspect_df_NA(pisa_europe)
plots
```

Analytically

```{r}
# help(gg_miss_case)
#visually
#gg_miss_case(inspect_world,facet = CNT)

#analytically
#na_count_by_group <- aggregate(. ~ inspect_world$CNT,inspect_world,function(x) { sum(is.na(x)) },na.action = NULL) 

##add nations count to the dataframe
#nation_count <- inspect_world %>% group_by(CNT) %>% summarise(total_count = n())
#na_count_by_group["nation count"] <- nation_count$total_count
```

# TREATMENT OF NAs

```{r}
# 1) first option removing NAs with na.omit()
# europe_woNA <- na.omit(europe_sel)
# 2) filling with mean or median
library(tidyr)
europe_woNA <- pisa_europe %>% group_by(CNT) %>% mutate_if(is.numeric, ~replace_na(.,mean(., na.rm = TRUE)))
#check if we have removed NAs
vis_miss(europe_woNA,warn_large_data = FALSE)
```

# SAVING DATA

```{r,}
# saving_dir = paste(working_dir,"/data/pisa-woNA.csv",sep="")
# write.csv(europe_woNA,file=saving_dir)
```

# OBSERVATIONS AND TODO

-   analysis for plausible values
-   try filling with different methods
