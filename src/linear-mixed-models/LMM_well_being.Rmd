---
title: "R Notebook"
# output: html_notebook
editor_options:
  chunk_output_type: inline
---


```{r}
library(mvtnorm)
library(MASS)
library(car)
library(rgl)
library(leaps)
library(ISLR)
library(glmnet)
library(lme4)
library(nlmeU) ## --> for the dataset
library(nlme)  ## --> for models implementation

library(corrplot)
library(lattice)
library(plot.matrix)

library(insight)
```

```{r}
root_proj_dir = "../../"
dataset_path = paste(root_proj_dir,"data/pisa_scores_final.csv",sep="")
include_path = paste(root_proj_dir,"src/include/Utilities.R",sep="")
#INCLUDING UTILITIES
source(include_path)
#IMPORTING THE DATASET
data <- read.csv(file=dataset_path)
head(data)
```

# [0] DATA PREP
```{r}
data$X <- NULL
data$SCHLTYPE <- as.factor(data$SCHLTYPE)
data$CNT <- as.factor(data$CNT)

IM_PUBLIC = rep(0,dim(data)[1])
IM_PUBLIC [which(data$SCHLTYPE=="Public")] = 1
data$IM_PUBLIC = as.factor(IM_PUBLIC)
data$SCHLTYPE <- NULL

```
### creazione unico factor combinato
```{r}
# Example categorical variables
index_cnt = grep("CNT",colnames(data))

colnames(data)

levels(data[,index_cnt])=levels(data$CNT)
cat_var1 <- data[,index_cnt]

index_public= grep("IM_PUBLIC",colnames(data))
levels(data[,index_public])=levels(data$IM_PUBLIC)
cat_var2 <- data[,index_public]

# Combine categorical variables
new_var <- interaction(cat_var1, cat_var2, sep = "-")
levels(new_var)
length(levels(new_var))

data$NEW_VAR = as.factor(new_var)
colnames(data)
```


# [1] Definizione formule
Please tenete questa sezione alla fine delle vostre analisi, mi serve per avere le formule definitive da usare nei modelli per calcolare il punteggio del gioco nel bot. Grazie! :)

```{r}
FORMULA_SOCIAL = "Social.well.being ~ Approach.to.ICT+Use.of.ICT+Teachers..degree+Teacher.skill+ESCS+RATCMP1+ICTSCH+HEDRES+STUBEHA+ATTLNACT+JOYREAD+PROAT6+CLSIZE+EDUSHORT+STAFFSHORT+PV1MATH+PV1READ+CNT+IM_PUBLIC"

FORMULA_SOCIAL_LMM  = "Social.well.being ~ Approach.to.ICT+Use.of.ICT+Teachers..degree+Teacher.skill+ESCS+RATCMP1+ICTSCH+HEDRES+STUBEHA+ATTLNACT+JOYREAD+PROAT6+CLSIZE+EDUSHORT+STAFFSHORT+PV1MATH+PV1READ+(1|NEW_VAR)"

FORMULA_PSYCH = "Psychological.well.being ~ Approach.to.ICT+Use.of.ICT+Teacher.skill+ESCS+RATCMP1+ICTSCH+ICTRES+ENTUSE+LM_MINS+HEDRES+ATTLNACT+PROAT6+CLSIZE+EDUSHORT+PV1MATH+PV1READ+CNT+IM_PUBLIC"

FORMULA_PSYCH_LMM = "Psychological.well.being ~ Approach.to.ICT+Use.of.ICT+Teacher.skill+ESCS+RATCMP1+ICTSCH+ICTRES+ENTUSE+LM_MINS+HEDRES+ATTLNACT+PROAT6+CLSIZE+EDUSHORT+PV1MATH+PV1READ+(1|NEW_VAR)"
```

# [2] Gestione outliers

```{r}
numerical_variables = c(1:23,25,26)
M = colMeans(data[,numerical_variables])
S = cov(data[,numerical_variables])
d2 = matrix(mahalanobis(data[,numerical_variables], M, S))
hist(d2,breaks = 300,xlim = c(0,300))
```



# [2.1] Soglie migliori trovate
## Social
```{r}
BEST_SOGLIA_SOCIAL = 24.3
SOGLIA = BEST_SOGLIA_SOCIAL
data_social_woo = data[which(d2 <= SOGLIA), ]
print(paste("From",dim(data)[1],"obs we moved to",dim(data_woo)[1]))
print(paste("Percentuale di dati sopravvissuti:",dim(data_woo)[1]/dim(data)[1]*100,"%"))
```

## Psych
```{r}
BEST_SOGLIA_PSYCH = 24.26
SOGLIA = BEST_SOGLIA_PSYCH
data_psych_woo = data[which(d2 <= SOGLIA), ]
print(paste("From",dim(data)[1],"obs we moved to",dim(data_woo)[1]))
print(paste("Percentuale di dati sopravvissuti:",dim(data_woo)[1]/dim(data)[1]*100,"%"))
```

# [2.2] Se volete provare ancora
```{r}
##########################
FORMULA = FORMULA_SOCIAL_LMM
# FORMULA = FORMULA_PSYCH_LMM
SOGLIA_RANGE = seq(20,40,by=1)
SOGLIA_PVALUE_INTERESSANTI = 0.05
##########################

for (soglia in SOGLIA_RANGE ){
  data_woo = data[which(d2 <= soglia), ]
  
  suppressWarnings({fit = lmer(FORMULA_SOCIAL_LMM,data=data_woo)})
  # fit
  sigma2_eps <- as.numeric(get_variance_residual(fit))
  sigma2_b <- as.numeric(get_variance_random(fit))
  PVRE <- sigma2_b/(sigma2_b+sigma2_eps)
  # print(paste("PVRE social =",PVRE))

  pval=round(shapiro.test(resid(fit))$p,digits=4)
  if(pval>SOGLIA_PVALUE_INTERESSANTI){
    print(paste0(
      "% rimasta = ",round(dim(data_woo)[1]/dim(data)[1]*100,digits=2),
      # "PVRE = ",PVRE,
      "  soglia = ",soglia,
      "  pvalue = ",pval))
  }
}
```



# [3] Creazione dei fit

## Ripresa dati_woo ufficiali
Ufficiali per ora.
```{r}
data_social_woo = read.csv("data_social_woo.csv")
data_psych_woo = read.csv("data_psych_woo.csv")
```


```{r}
fit_social_lm = lm(FORMULA_SOCIAL,data=data_social_woo)
fit_psych_lm = lm(FORMULA_PSYCH,data=data_psych_woo)

fit_social_lmm = lmer(FORMULA_SOCIAL_LMM,data=data_social_woo)
fit_psych_lmm = lmer(FORMULA_PSYCH_LMM,data=data_psych_woo)
```


```{r}
fit_social_lm$coefficients
fixef(fit_social_lmm)
```


# [4] Assumptions LM
```{r}
#############################
fit = fit_social_lm
df = data_social_woo
# fit = fit_psych_lm
# df = data_psych_woo
#############################
res = fit$residuals
alpha = 0.05

shapiro.test(res)$p
print(paste("Normality of residuals?",shapiro.test(res)$p>alpha))
qqnorm(res)
qqline(res,col="red")

# homoschedasticity
boxplot(res ~ df$NEW_VAR,las=2)
boxplot(res ~ df$CNT,las=2)
```


# [5] Assumptions LMM
```{r}
#############################
fit = fit_social_lmm
df = data_social_woo
# fit = fit_psych_lmm
# df = data_psych_woo
#############################
res = residuals(fit)
raneff = unlist(ranef(fit))
alpha = 0.05

shapiro.test(res)$p
shapiro.test(raneff)$p
print(paste("Normality of residuals?",shapiro.test(res)$p>alpha))
print(paste("Normality of rand effects?",shapiro.test(raneff)$p>alpha))
qqnorm(res)
qqline(res,col="red")
qqnorm(raneff)
qqline(raneff,col="red")

# homoschedasticity
boxplot(res ~ df$NEW_VAR,las=2)
boxplot(res ~ df$CNT,las=2)
```



# [6] Random effects
```{r}
#############################
fit = fit_social_lmm
# fit = fit_psych_lmm
#############################

dotplot(ranef(fit, condVar=T))$NEW_VAR
ranef(fit)
```


# [7] Analisi outliers
```{r}
data_out_social = data[which(d2 > BEST_SOGLIA_SOCIAL), ]
data_out_psych = data[which(d2 > BEST_SOGLIA_PSYCH), ]
```

## Social or Psych
```{r}
###########################
df = data_out_social 
# df = data_out_psych 
###########################

for (i in 1:length(STATES)) { # STATES sta in Utilities
	print(paste(STATES[i],":",sum(df_out_social$CNT==STATES[i]),"outliers out of",
		  sum(data$CNT==STATES[i]),"obs originally  %lost =",
					sum(df_out_social$CNT==STATES[i])/sum(data$CNT==STATES[i])*100))
}


```




