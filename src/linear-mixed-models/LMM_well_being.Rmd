---
title: "R Notebook"
# output: html_notebook
editor_options:
  chunk_output_type: inline
---


```{r}
library(mvtnorm)
library(MASS)
library(car)
library(rgl)
library(leaps)
library(ISLR)
library(glmnet)
library(lme4)
library(nlmeU) ## --> for the dataset
library(nlme)  ## --> for models implementation

library(corrplot)
library(lattice)
library(plot.matrix)

library(insight)
```

```{r}
root_proj_dir = "../../"
dataset_path = paste(root_proj_dir,"data/pisa_scores_final.csv",sep="")
include_path = paste(root_proj_dir,"src/include/Utilities.R",sep="")
#INCLUDING UTILITIES
source(include_path)
#IMPORTING THE DATASET
data <- read.csv(file=dataset_path)
head(data)
```

# [0] DATA PREP
```{r}
data$X <- NULL
data$SCHLTYPE <- as.factor(data$SCHLTYPE)
data$CNT <- as.factor(data$CNT)

IM_PUBLIC = rep(0,dim(data)[1])
IM_PUBLIC [which(data$SCHLTYPE=="Public")] = 1
data$IM_PUBLIC = as.factor(IM_PUBLIC)
data$SCHLTYPE <- NULL
```
### creazione unico factor combinato
```{r}
# Example categorical variables
index_cnt = grep("CNT",colnames(data))

colnames(data)

levels(data[,index_cnt])=levels(data$CNT)
cat_var1 <- data[,index_cnt]

index_public= grep("IM_PUBLIC",colnames(data))
levels(data[,index_public])=levels(data$IM_PUBLIC)
cat_var2 <- data[,index_public]

# Combine categorical variables
new_var <- interaction(cat_var1, cat_var2, sep = "-")
levels(new_var)
length(levels(new_var))

data$NEW_VAR = as.factor(new_var)
colnames(data)
```


# [1] Definizione formule
```{r}
FORMULA_SOCIAL = "Social.well.being ~ Approach.to.ICT+Use.of.ICT+Teachers..degree+Teacher.skill+ESCS+RATCMP1+ICTSCH+HEDRES+STUBEHA+ATTLNACT+JOYREAD+PROAT6+CLSIZE+EDUSHORT+STAFFSHORT+PV1MATH+PV1READ+CNT+IM_PUBLIC"

FORMULA_SOCIAL_LMM  = "Social.well.being ~ Approach.to.ICT+Use.of.ICT+Teachers..degree+Teacher.skill+ESCS+RATCMP1+ICTSCH+HEDRES+STUBEHA+ATTLNACT+JOYREAD+PROAT6+CLSIZE+EDUSHORT+STAFFSHORT+PV1MATH+PV1READ+(1|NEW_VAR)"

FORMULA_PSYCH = "Psychological.well.being ~ Approach.to.ICT+Use.of.ICT+Teacher.skill+ESCS+RATCMP1+ICTSCH+ICTRES+ENTUSE+LM_MINS+HEDRES+ATTLNACT+PROAT6+CLSIZE+EDUSHORT+PV1MATH+PV1READ+CNT+IM_PUBLIC"

FORMULA_PSYCH_LMM = "Psychological.well.being ~ Approach.to.ICT+Use.of.ICT+Teacher.skill+ESCS+RATCMP1+ICTSCH+ICTRES+ENTUSE+LM_MINS+HEDRES+ATTLNACT+PROAT6+CLSIZE+EDUSHORT+PV1MATH+PV1READ+(1|NEW_VAR)"
```

```{r}
linear_model_vars <- readLines("../../data/non csv/lm_social_vars.txt")

vars = c(linear_model_vars,"CNT","IM_PUBLIC")
FORMULA_SOCIAL <- paste(paste("Social.well.being","~"), paste(vars, collapse = "+"))
```

```{r}
linear_model_vars <- readLines("../../data/non csv/lm_psico_vars.txt")

vars = c(linear_model_vars,"CNT","IM_PUBLIC")
FORMULA_PSYCH <- paste(paste("Psychological.well.being","~"), paste(vars, collapse = "+"))
```


# [2] Gestione outliers
<<<<<<< Updated upstream

```{r}
numerical_variables = c(1:23,25,26)
M = colMeans(data[,numerical_variables])
S = cov(data[,numerical_variables])
d2 = matrix(mahalanobis(data[,numerical_variables], M, S))
hist(d2,breaks = 300,xlim = c(0,300))
```


=======
```{r}
M = colMeans(data[,numerical_relevant_variables])
S = cov(data[,numerical_relevant_variables])
d2 = matrix(mahalanobis(data[,numerical_relevant_variables], M, S))
```

>>>>>>> Stashed changes
## Social
```{r}
BEST_SOGLIA = 24.3
SOGLIA = BEST_SOGLIA
data_social_woo = data[which(d2 <= SOGLIA), ]
print(paste("From",dim(data)[1],"obs we moved to",dim(data_woo)[1]))
print(paste("Percentuale di dati sopravvissuti:",dim(data_woo)[1]/dim(data)[1]*100,"%"))
```

## Psych
```{r}
BEST_SOGLIA = 24.26
SOGLIA = BEST_SOGLIA
data_psych_woo = data[which(d2 <= SOGLIA), ]
print(paste("From",dim(data)[1],"obs we moved to",dim(data_woo)[1]))
print(paste("Percentuale di dati sopravvissuti:",dim(data_woo)[1]/dim(data)[1]*100,"%"))
```



# [3] Creazione dei fit
```{r}
fit_social_lm = lm(FORMULA_SOCIAL,data=data_psych_woo)
fit_psych_lm = lm(FORMULA_PSYCH,data=data_psych_woo)

fit_social_lmm = lmer(FORMULA_SOCIAL_LMM,data=data_social_woo)
fit_psych_lmm = lmer(FORMULA_PSYCH_LMM,data=data_psych_woo)
```


```{r}
fit_social_lm$coefficients
fixef(fit_social_lmm)
```

# Linear hypothesis
```{r}
fm = fit_social_lm
summary(fm)
b=coefficients(fm)
```

# SOCIAL 
```{r}
vars_to_discard = c("CLSIZE",
                    "ESCS",
                    "STAFFSHORT",
                    "STUBEHA",
                    "EDUSHORT",
                    "PROAT6"
                    
                    )
check_beta <- which(names(b)%in%vars_to_discard)
C <- c()
for( i in 1: length(check_beta)){
  vect <- rep(0,fm$rank)
  vect[check_beta[i]] <- 1
  C <- rbind(C,vect)
}
linearHypothesis(fm, C, rep(0,length(check_beta)))

```
# PSYCHO
```{r}

```



# [4] Assumptions LM
## Social or Psych
```{r}
#############################
fit = fit_social_lm
df = data_social_woo
# fit = fit_psych_lm
# df = data_psych_woo
#############################
res = fit$residuals
alpha = 0.05
```

```{r}
shapiro.test(res)$p
print(paste("Normality of residuals?",shapiro.test(res)$p>alpha))
qqnorm(res)
qqline(res,col="red")

# homoschedasticity
boxplot(res ~ df$NEW_VAR,las=2)
boxplot(res ~ df$CNT,las=2)
```


# [5] Assumptions LMM
## Social or Psych
```{r}
#############################
fit = fit_social_lmm
df = data_social_woo
# fit = fit_psych_lmm
# df = data_psych_woo
#############################
res = residuals(fit)
raneff = unlist(ranef(fit))
alpha = 0.05
```

```{r}
shapiro.test(res)$p
shapiro.test(raneff)$p
print(paste("Normality of residuals?",shapiro.test(res)$p>alpha))
print(paste("Normality of rand effects?",shapiro.test(raneff)$p>alpha))
qqnorm(res)
qqline(res,col="red")
qqnorm(raneff)
qqline(raneff,col="red")

# homoschedasticity
boxplot(res ~ df$NEW_VAR,las=2)
boxplot(res ~ df$CNT,las=2)
```



# [6] Random effects
## Social or Psych
```{r}
#############################
fit = fit_social_lmm
# fit = fit_psych_lmm
#############################

dotplot(ranef(fit, condVar=T))$NEW_VAR
```


# [7] Analisi outliers
```{r}
data_outl_social = data[which(d2 > 24.3), ]
data_outl_psych = data[which(d2 > 24.26), ]
```






